---
alwaysApply: true
---

## Phase 2: Generate Workflow Files

1. **Load all steps from `cicd-phases/phase2-generate-workflow.mdc`**
2. Execute steps to render workflow YAML, match jobs to context, and checkpoint before review.
3. **Update plan checkboxes** - Mark completed steps [x] in plan document `.cicd-docs/workflow-generation-plan.md` (or `.cicd-docs/phase2-plan.md`) as work progresses
4. **Update cicd-state.md** - Update Phase 2 status and generated files list after completion
5. **Log prompt with timestamp** - Record approval prompt in `.cicd-docs/audit.md` before asking
6. **Ask for Confirmation and WAIT**: Ask: "Single production workflow generated. Are you ready to review and confirm?" - DO NOT PROCEED until user confirms
7. **Log response with timestamp** - Record user response in `.cicd-docs/audit.md` after receiving it
8. **MANDATORY**: Remind user to commit artifacts to git after phase completion

---

## Phase 3: Review & Confirm

1. **Load all steps from `cicd-phases/phase3-review-confirm.mdc`**
2. Execute steps to review generated workflows, present details, and checkpoint before finalization.
3. **Update plan checkboxes** - Mark completed steps [x] in plan document `.cicd-docs/review-notes.md` (or `.cicd-docs/phase3-notes.md`) as work progresses
4. **Update cicd-state.md** - Update Phase 3 status and review notes after completion
5. **Log prompt with timestamp** - Record approval prompt in `.cicd-docs/audit.md` before asking
6. **Ask for Final Confirmation**: Ask: "Single production CICD workflow complete. Do you approve the final workflow for integration?" - DO NOT PROCEED until user confirms
7. **Log response with timestamp** - Record user response in `.cicd-docs/audit.md` after receiving it
8. **MANDATORY**: Remind user to commit artifacts to git after phase completion

---

# Phase 4: Commit & Push

1. **Load all steps from `cicd-phases/phase4-commit-push.mdc`**
2. Execute steps to commit generated/updated workflow files and push to the repository, only after explicit user approval.
3. **Update plan checkboxes** - Mark completed steps [x] in plan document `.cicd-docs/review-notes.md` (or `.cicd-docs/phase3-notes.md`) as work progresses
4. **Update cicd-state.md** - Update Phase 4 status and mark overall workflow as complete
5. **Log prompt with timestamp** - Record approval prompt in `.cicd-docs/audit.md` before asking
6. **Ask for Confirmation and WAIT**: Ask: "Ready to commit and push the workflow changes to the repository?" - DO NOT PROCEED until user confirms
7. **Log response with timestamp** - Record user response in `.cicd-docs/audit.md` after receiving it

---

# Key Workflow Requirements

## Language-Agnostic Detection

- Automatically scan repository for ALL code types (Python, Terraform, JavaScript/TypeScript, Java, Go, Docker, Kubernetes, etc.)
- Detect code presence by file extensions and directory patterns
- Generate workflows ONLY for detected code types
- If existing workflows exist, analyze them and modify/remove as needed based on current codebase

## Single Production CI/CD Workflow Architecture

### Unified Single Workflow Architecture

Generate **one unified production workflow file** (`.github/workflows/ci-cd.yml`) that contains jobs for ALL detected code types:

**Single Production Workflow** (`.github/workflows/ci-cd.yml`):

- **Trigger**:
  - Runs on pushes to `main` branch only
  - Supports `workflow_dispatch` trigger for manual execution
- **Environment**: Single production environment (all deploy jobs use `environment: production`)
- **Structure**: Contains jobs for each code type sequenced by dependencies
- **Job Structure for Each Code Type**:
  - **CI Jobs** (run in parallel): lint, security scan, test
  - **Build Job** (runs after CI jobs): Build and package artifacts
  - **Deploy Job** (runs after build and upstream dependencies): Deploy to production
- **Dependency Handling**: Job dependencies (`needs:`) enforce execution order within the same workflow
- **Artifact Passing**: Artifacts are passed between jobs using GitHub Actions artifacts within the same workflow

**Workflow Structure:**

- Single workflow file contains all code types
- Jobs are sequenced by dependencies using `needs:` dependencies
- Code types with no dependencies run first
- Dependent code types wait for upstream deploy jobs to complete
- All deploy jobs use `environment: production`
- **Trigger Logic**: `main` branch push only (no other branch triggers)
- **Dependency Handling**: Job dependencies within the same workflow manage execution order

## Workflow Requirements

**CRITICAL**: All generated workflow files MUST be free of linting errors. Workflows must:

- Have valid YAML syntax
- Use correct GitHub Actions expression syntax (`${{ }}` for all functions)
- Have no missing required fields
- Have valid job dependencies and workflow triggers
- Pass GitHub Actions workflow validation

- All workflows must include:
  - CI/CD best practices (lint, test, scan, artifact upload, etc.)
  - Language-appropriate security scanning
  - Proper permissions and AWS credential configuration when needed
- Modular, extensible and production-grade workflows
- Minimal, clear confirmation at each phase
- Existing workflow management: modify existing workflows or remove obsolete ones

## Code Type Detection Patterns

The system scans for common code types using file patterns and directory structures:

- **Python**: `.py` files, `requirements.txt`, `setup.py`, `pyproject.toml`, `Pipfile`
- **Terraform**: `.tf` files, `.tfvars` files, `terraform/` directories
- **JavaScript/TypeScript**: `.js`, `.jsx`, `.ts`, `.tsx` files, `package.json`, `node_modules/`
- **Java**: `.java` files, `pom.xml`, `build.gradle`, `Maven`, `Gradle` directories
- **Go**: `.go` files, `go.mod`, `go.sum`
- **Docker**: `Dockerfile`, `docker-compose.yml`, `.dockerignore`
- **Kubernetes**: `.yaml`/`.yml` files in `k8s/`, `kubernetes/`, `manifests/` directories
- **CloudFormation**: `.yaml`/`.yml` files with CloudFormation templates, `cfn/` directories
- **CDK**: `cdk.json`, `cdk/` directories, TypeScript/Python/Java CDK code

## Language-Specific CI/CD Standards

**CRITICAL**: Language-specific guidance for CI/CD workflows is stored in separate standards files within `.cursor/rules/cicd-phases/`:

- `python-standards.mdc` - Python CI/CD workflow patterns and standards
- `terraform-standards.mdc` - Terraform CI/CD workflow patterns and standards
- `javascript-standards.mdc` - JavaScript/TypeScript CI/CD workflow patterns and standards
- `java-standards.mdc` - Java CI/CD workflow patterns and standards
- `go-standards.mdc` - Go CI/CD workflow patterns and standards
- `docker-standards.mdc` - Docker CI/CD workflow patterns and standards
- `kubernetes-standards.mdc` - Kubernetes CI/CD workflow patterns and standards
- `cloudformation-standards.mdc` - CloudFormation CI/CD workflow patterns and standards
- `cdk-standards.mdc` - CDK CI/CD workflow patterns and standards

When generating workflows for a detected code type, you MUST:

1. Read the corresponding standards file from `.cursor/rules/cicd-phases/{code-type}-standards.mdc`
2. Apply the complete content from that file when generating the workflow
3. Do not summarize or paraphrase - use the complete content as written

If a standards file does not exist for a detected code type, create it following the pattern of existing standards files and include language-appropriate CI/CD patterns.

## CRITICAL: Plan-Level Checkbox Enforcement

### MANDATORY RULES FOR PLAN EXECUTION

1. **NEVER complete any work without updating plan checkboxes**
2. **IMMEDIATELY after completing ANY step described in a plan file, mark that step [x]**
3. **This must happen in the SAME interaction where the work is completed**
4. **Example**: When generating workflow files, mark "Generate python-ci.yml workflow" as [x] in the workflow generation plan
5. **NO EXCEPTIONS**: Every plan step completion MUST be tracked with checkbox updates

### Two-Level Checkbox Tracking System

The workflow uses a two-level checkbox tracking system:

#### 1. Plan-Level Execution Tracking (Plan Files)

- **Purpose**: Track detailed execution progress within each phase
- **Location**: Individual plan files in `.cicd-docs/` directory (preferred) or `.cursor/rules/cicd-phases/` (legacy fallback)
- **Plan Documents**:
  - **Phase 1**: `.cicd-docs/detection-plan.md` (or `.cicd-docs/phase1-plan.md`)
  - **Phase 2**: `.cicd-docs/workflow-generation-plan.md` (or `.cicd-docs/phase2-plan.md`)
  - **Phase 3**: `.cicd-docs/review-notes.md` (or `.cicd-docs/phase3-notes.md`)
- **When to Update**: Mark steps [x] as you complete the specific work described in that step
- **MANDATORY**: Update immediately after completing work, never skip this step

#### 2. Phase-Level Progress Tracking (cicd-state.md)

- **Purpose**: Track overall workflow progress across phases
- **Location**: `.cicd-docs/cicd-state.md` (preferred) or `.cursor/rules/cicd-phases/cicd-state.mdc` (legacy fallback)
- **When to Update**: Mark phases [x] only when the entire phase is complete and approved by user

### Mandatory Update Rules

- **Plan Files**: Update checkboxes [x] immediately after completing each step's work
- **cicd-state.md**: Update phase checkboxes [x] only after user approval to proceed
- **Current Status**: Always update the "Current Status" section in cicd-state.md after any progress
- **Same Interaction**: All progress updates must happen in the SAME interaction where work is completed
- **Never Skip**: Never end an interaction without updating progress tracking

## Prompts Logging Requirements

- **MANDATORY**: Log every approval prompt with timestamp before asking the user
- **MANDATORY**: Record every user response with timestamp after receiving it
- Use ISO 8601 format for timestamps (YYYY-MM-DDTHH:MM:SSZ)
- Include phase context and approval status for each entry
- Maintain chronological order of all interactions
- Use the following format for each entry:

```markdown
## Phase X: [Phase Name]

**Timestamp**: 2025-01-28T14:32:15Z
**Prompt**: "[Exact prompt text asked to user]"
**Response**: "[User's exact response]"
**Status**: [Approved/Rejected/Pending]
**Context**: [Additional context if needed]

---
```

# Directory/File Naming

## Workflow Files

**Single Production Workflow File**:

- `.github/workflows/ci-cd.yml` - Single unified production workflow containing all code types
  - Triggers on `main` branch push only
  - Contains jobs for all detected code types sequenced by dependencies
  - All deploy jobs use `environment: production`

Use kebab-case for workflow file name: `ci-cd.yml`

## Directory Structure

```
.cicd-docs/                    # Preferred location for project-scoped CICD artifacts
├── cicd-state.md              # Master state tracking file with phase checkboxes
└── audit.md                   # Record approvals from users with timestamp for each CICD phase

.github/
└── workflows/                 # Generated GitHub Actions workflow files
    └── ci-cd.yml                  # Single production workflow (triggered by main branch)

.cursor/rules/cicd-phases/    # CI/CD workflow generation rules
├── cicd-state.mdc              # Legacy state file (only if .cicd-docs/ doesn't exist)
├── {code-type}-standards.mdc   # Language-specific CI/CD standards (one per code type)
└── [phase files]              # Phase execution instructions
```

# Principles

- **Language-Agnostic Detection**: Scan for ALL code types in the repository, not just Python/Terraform
- **Simplified Re-generation**: For regeneration requests, simply delete `.cicd-docs/` and `.github/workflows/` directories before starting - ensures completely clean start
- **Existing Workflow Management**: For new generation (not regeneration), existing workflows in `.github/workflows/` will be replaced by the newly generated single production workflow
- Always generate ONLY for detected code types
- **Single Production Workflow**: Generate one unified workflow file containing all code types:
  - `ci-cd.yml` - Single production workflow (triggers on `main` branch push only)
  - Contains jobs for all detected code types sequenced by dependencies
  - All deploy jobs use `environment: production`
- **No Orchestrator Workflows**: Not needed for single workflow architecture - dependencies managed via job `needs:` within the same workflow
- **No Multi-Environment Workflows**: Single production environment only - no dev/test/prod separation
- **Branch-Based Deployment Trigger**:
  - Main branch push → Single production workflow (direct push trigger)
  - No other branch triggers
- **Language-Specific Standards**: Read and apply complete content from `{code-type}-standards.mdc` files in `cicd-phases/` directory
- Minimal, modular checkpoints across all phases
- **MANDATORY**: Use the two-level checkbox tracking system (plan files + cicd-state.md)
- **MANDATORY**: Update plan file checkboxes [x] immediately after completing each step's work
- **MANDATORY**: Update cicd-state.md phase checkboxes [x] only after user approval to proceed
- **MANDATORY**: Update the "Current Status" section in cicd-state.md after any progress
- **MANDATORY**: Log all prompts and responses with timestamps in audit.md
- **MANDATORY**: Remind user to commit artifacts to git after every phase completion
- Ensure explicit approval at each phase transition
- Load context incrementally - each phase needs context from all previous phases

# Session Continuity (Summary)

- Always follow `cicd-phases/session-continuity.mdc` for detecting/resuming sessions
- Prefer storing state and approvals under project docs: `.cicd-docs/cicd-state.md` and `.cicd-docs/audit.md` (fallback to legacy `.cursor/rules/cicd-phases/cicd-state.mdc` if needed)
- Always read cicd-state.md first to understand current phase before proceeding
- Provide context summary when resuming sessions
