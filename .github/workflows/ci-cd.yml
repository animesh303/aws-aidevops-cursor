name: CI/CD

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Python CI Jobs (run in parallel for both features)
  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Install dependencies - s3-lambda-trigger
        working-directory: src/lambda-python-s3-lambda-trigger
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Run Flake8 - s3-lambda-trigger
        working-directory: src/lambda-python-s3-lambda-trigger
        run: |
          pip install flake8
          flake8 . || true
      - name: Install dependencies - step-function-demo
        working-directory: src/lambda-python-step-function-demo
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Run Flake8 - step-function-demo
        working-directory: src/lambda-python-step-function-demo
        run: |
          pip install flake8
          flake8 . || true

  python-security:
    name: Python Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install dependencies - s3-lambda-trigger
        working-directory: src/lambda-python-s3-lambda-trigger
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Run Bandit - s3-lambda-trigger
        working-directory: src/lambda-python-s3-lambda-trigger
        run: |
          pip install bandit
          bandit -r . || true
      - name: Install dependencies - step-function-demo
        working-directory: src/lambda-python-step-function-demo
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Run Bandit - step-function-demo
        working-directory: src/lambda-python-step-function-demo
        run: |
          pip install bandit
          bandit -r . || true

  python-test:
    name: Python Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Install dependencies - s3-lambda-trigger
        working-directory: src/lambda-python-s3-lambda-trigger
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Install test dependencies
        if: ${{ hashFiles('tests/**') != '' }}
        run: |
          pip install pytest pytest-cov
      - name: Run tests - s3-lambda-trigger
        if: ${{ hashFiles('tests/**') != '' }}
        working-directory: .
        run: |
          pytest tests/s3-lambda-trigger/ --cov=src/lambda-python-s3-lambda-trigger --cov-report=xml --cov-report=html || true
      - name: Install dependencies - step-function-demo
        working-directory: src/lambda-python-step-function-demo
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Run tests - step-function-demo
        if: ${{ hashFiles('tests/**') != '' }}
        working-directory: .
        run: |
          pytest tests/step-function-demo/ --cov=src/lambda-python-step-function-demo --cov-report=xml --cov-report=html || true
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/
          retention-days: 1

  # Terraform CI Jobs (run in parallel)
  terraform-security:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Run Checkov
        working-directory: iac/terraform
        run: |
          pip install checkov
          checkov -d . || true

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Configure Terraform Cloud
        working-directory: iac/terraform
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          if [ -n "$TFC_TOKEN" ]; then
            cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
          fi
      - name: Terraform Init
        working-directory: iac/terraform
        run: terraform init -backend=false
      - name: Terraform Validate
        working-directory: iac/terraform
        run: terraform validate
      - name: Terraform Format Check
        working-directory: iac/terraform
        run: terraform fmt

  # Terraform Deploy Job (Combined: Python Build + Terraform Deploy)
  terraform-deploy:
    name: Build Lambda and Deploy Terraform
    needs: [python-lint, python-security, python-test, terraform-security, terraform-validate]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      # Python Build Steps (build artifacts where Terraform expects them)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      
      # Build s3-lambda-trigger Lambda package
      - name: Install dependencies - s3-lambda-trigger
        working-directory: src/lambda-python-s3-lambda-trigger
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Build Lambda package for s3-lambda-trigger
        run: |
          mkdir -p ./iac/terraform
          cd src/lambda-python-s3-lambda-trigger
          zip -r ../../iac/terraform/s3-lambda-trigger-lambda_function.zip . -x "*.git*" "*.md" "tests/*" "*.tf*" "iac/**"
          cd ../..
          echo "✓ s3-lambda-trigger Lambda package built at: ./iac/terraform/s3-lambda-trigger-lambda_function.zip"
          ls -lh ./iac/terraform/s3-lambda-trigger-lambda_function.zip
      
      # Build step-function-demo Lambda package
      - name: Install dependencies - step-function-demo
        working-directory: src/lambda-python-step-function-demo
        run: |
          if [ -f requirements.txt ] && [ -s requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Build Lambda package for step-function-demo
        run: |
          mkdir -p ./iac/terraform
          cd src/lambda-python-step-function-demo
          zip -r ../../iac/terraform/step-function-demo-lambda_function.zip . -x "*.git*" "*.md" "tests/*" "*.tf*" "iac/**"
          cd ../..
          echo "✓ step-function-demo Lambda package built at: ./iac/terraform/step-function-demo-lambda_function.zip"
          ls -lh ./iac/terraform/step-function-demo-lambda_function.zip
      
      # Verify artifacts exist before Terraform operations
      - name: Verify Lambda packages exist
        run: |
          S3_LAMBDA_PATH="./iac/terraform/s3-lambda-trigger-lambda_function.zip"
          SF_LAMBDA_PATH="./iac/terraform/step-function-demo-lambda_function.zip"
          if [ ! -f "$S3_LAMBDA_PATH" ]; then
            echo "Error: s3-lambda-trigger Lambda package not found at: $S3_LAMBDA_PATH"
            exit 1
          fi
          if [ ! -f "$SF_LAMBDA_PATH" ]; then
            echo "Error: step-function-demo Lambda package not found at: $SF_LAMBDA_PATH"
            exit 1
          fi
          echo "✓ Both Lambda packages verified"
          ls -lh ./iac/terraform/*lambda_function.zip
      
      # Terraform Deploy Steps
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.1
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Configure Terraform Cloud
        working-directory: iac/terraform
        env:
          TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
        run: |
          if [ -n "$TFC_TOKEN" ]; then
            cat > $HOME/.terraformrc << EOF
          credentials "app.terraform.io" {
            token = "$TFC_TOKEN"
          }
          EOF
          fi
      - name: Detect Terraform Cloud backend
        id: detect-tfc
        working-directory: iac/terraform
        run: |
          if grep -q "cloud" backend.tf 2>/dev/null || [ -n "$TFC_TOKEN" ]; then
            echo "USE_TFC=true" >> $GITHUB_ENV
            echo "Terraform Cloud backend detected"
          else
            echo "USE_TFC=false" >> $GITHUB_ENV
            echo "Standard backend detected"
          fi
      - name: Terraform Init
        working-directory: iac/terraform
        run: terraform init
      - name: Terraform Plan
        id: terraform-plan
        working-directory: iac/terraform
        run: |
          terraform plan \
            -var="lambda_zip_file=s3-lambda-trigger-lambda_function.zip" \
            -var="step_function_demo_lambda_zip_file=step-function-demo-lambda_function.zip" \
            -out=tfplan
        continue-on-error: true
      - name: Terraform Plan Status
        run: |
          if [ "${{ steps.terraform-plan.outcome }}" == "failure" ]; then
            echo "Plan failed, but continuing..."
          fi
      - name: Upload Terraform Plan
        if: env.USE_TFC == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: iac/terraform/tfplan
          retention-days: 1
      - name: Download Terraform Plan
        if: env.USE_TFC == 'false'
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: iac/terraform/
      - name: Terraform Apply
        working-directory: iac/terraform
        run: |
          if [ "$USE_TFC" == "true" ]; then
            terraform apply \
              -var="lambda_zip_file=s3-lambda-trigger-lambda_function.zip" \
              -var="step_function_demo_lambda_zip_file=step-function-demo-lambda_function.zip" \
              -auto-approve
          else
            terraform apply \
              -var="lambda_zip_file=s3-lambda-trigger-lambda_function.zip" \
              -var="step_function_demo_lambda_zip_file=step-function-demo-lambda_function.zip" \
              tfplan
          fi

